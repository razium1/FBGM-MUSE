<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football-GM Query</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #playerFaceCanvas {
            margin: 20px 0;
        }
        .d-none {
            display: none;
        }
        .player-card {
            padding: 20px;
            border-radius: 10px;
            background-color: #f8f9fa;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center mb-4">Football-GM Query</h1>

    <!-- File Upload -->
    <div class="mb-3">
        <label for="uploadFile" class="form-label">Upload Football-GM League File (JSON):</label>
        <input type="file" id="uploadFile" class="form-control">
        <button id="uploadBtn" class="btn btn-primary mt-2">Upload File</button>
    </div>

    <!-- Query Input -->
    <div class="mb-3">
        <label for="queryInput" class="form-label">Ask a Question (e.g., "How many touchdowns did Casey Weber score?"):</label>
        <input type="text" id="queryInput" class="form-control">
        <button id="queryBtn" class="btn btn-primary mt-2">Submit Query</button>
    </div>

    <!-- Query Result -->
    <div id="resultContainer">
        <h3 id="resultTitle" class="text-center"></h3>
        <p id="result" class="text-center"></p>

        <!-- Player Face Canvas -->
        <div id="playerFaceCanvasContainer" class="text-center d-none">
            <canvas id="playerFaceCanvas" width="150" height="150"></canvas>
        </div>

        <!-- Team Logo Placeholder -->
        <div id="teamLogoContainer" class="d-none">
            <img id="teamLogo" src="" alt="Team Logo" width="150" height="150">
        </div>
    </div>
</div>

<script>
    let leagueData = null;

    // Handle file upload and parse JSON
    document.getElementById('uploadBtn').addEventListener('click', () => {
        const fileInput = document.getElementById('uploadFile');
        const file = fileInput.files[0];

        if (!file) {
            alert("Please upload a JSON file.");
            return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
            const text = e.target.result;
            try {
                leagueData = JSON.parse(text);
                alert('File uploaded and parsed successfully.');
            } catch (error) {
                alert('Error parsing the JSON file. Please check the file format.');
            }
        };

        reader.readAsText(file);
    });

    // Handle user query
    document.getElementById('queryBtn').addEventListener('click', () => {
        const query = document.getElementById('queryInput').value.toLowerCase();
        if (!leagueData) {
            alert('Please upload a league file first.');
            return;
        }

        const players = leagueData.players || [];
        const teams = leagueData.teams || [];

        let result = '';
        let matchedPlayer = findPlayerInQuery(query, players);
        let matchedTeam = findTeamInQuery(query, teams);

        if (matchedPlayer) {
            result = handlePlayerQuery(query, matchedPlayer);
            renderPlayerFace(matchedPlayer.face); // Render player face using manual canvas rendering
        } else if (matchedTeam) {
            result = handleTeamQuery(query, matchedTeam);
            renderTeamLogo(matchedTeam.imgURL); // Render team logo
        } else {
            result = 'Could not understand your query. Please ask about player or team stats.';
        }

        document.getElementById('resultTitle').textContent = "Query Result";
        document.getElementById('result').textContent = result;
    });

    // Find player by name in query
    function findPlayerInQuery(query, players) {
        return players.find(player => {
            const fullName = `${player.firstName.toLowerCase()} ${player.lastName.toLowerCase()}`;
            return query.includes(player.firstName.toLowerCase()) && query.includes(player.lastName.toLowerCase());
        });
    }

    // Find team by name in query
    function findTeamInQuery(query, teams) {
        return teams.find(team => query.includes(team.name.toLowerCase()));
    }

    // Safely handle stats fetching from the player object
    function getPlayerStat(player, statName) {
        if (player.stats && player.stats.length > 0 && player.stats[0][statName] !== undefined) {
            return player.stats[0][statName];
        }
        return 0; // Default to 0 if stat is not found
    }

    // Function to match keywords and return the appropriate stat
    function matchKeywords(query) {
        const keywords = {
            'passing touchdowns': ['passing touchdowns', 'passing tds', 'threw touchdowns'],
            'passing attempts': ['passing attempts', 'passes thrown', 'pass attempts'],
            'rushing touchdowns': ['rushing touchdowns', 'rushing tds', 'rushed touchdowns'],
            'rushing attempts': ['rushing attempts', 'rush attempts', 'runs'],
            'receiving targets': ['receiving targets', 'targets', 'was targeted'],
            'catches': ['catches', 'receptions', 'caught'],
            'total touchdowns': ['touchdowns', 'scored'],
            'rushing yards': ['rushing yards', 'yards rushed'],
            'receiving yards': ['receiving yards', 'yards caught'],
            'passing yards': ['passing yards', 'threw yards', 'yards thrown'],
            'overall rating': ['overall rating', 'rating'],
            'speed': ['speed']
        };

        // Find matching keyword category
        for (const [stat, patterns] of Object.entries(keywords)) {
            for (const pattern of patterns) {
                if (query.includes(pattern)) {
                    return stat;
                }
            }
        }
        return null;
    }

    // Handle player queries with flexible keyword-based matching
    function handlePlayerQuery(query, player) {
        const stat = matchKeywords(query);
        let response = '';

        if (stat === 'passing touchdowns') {
            const passingTDs = getPlayerStat(player, 'pssTD');
            response = `${player.firstName} ${player.lastName} threw ${passingTDs} passing touchdowns in the 2024 season.`;
        } else if (stat === 'passing attempts') {
            const passingAttempts = getPlayerStat(player, 'pss');
            response = `${player.firstName} ${player.lastName} attempted ${passingAttempts} passes in the 2024 season.`;
        } else if (stat === 'rushing touchdowns') {
            const rushingTDs = getPlayerStat(player, 'rusTD');
            response = `${player.firstName} ${player.lastName} scored ${rushingTDs} rushing touchdowns in the 2024 season.`;
        } else if (stat === 'rushing attempts') {
            const rushingAttempts = getPlayerStat(player, 'rus');
            response = `${player.firstName} ${player.lastName} had ${rushingAttempts} rushing attempts in the 2024 season.`;
        } else if (stat === 'receiving targets') {
            const receivingTargets = getPlayerStat(player, 'tgt');
            response = `${player.firstName} ${player.lastName} had ${receivingTargets} receiving targets in the 2024 season.`;
        } else if (stat === 'catches') {
            const catches = getPlayerStat(player, 'rec');
            response = `${player.firstName} ${player.lastName} made ${catches} receptions in the 2024 season.`;
        } else if (stat === 'total touchdowns') {
            const receivingTDs = getPlayerStat(player, 'recTD');
            const rushingTDs = getPlayerStat(player, 'rusTD');
            const totalTDs = receivingTDs + rushingTDs;
            response = `${player.firstName} ${player.lastName} scored ${totalTDs} total touchdowns in the 2024 season.`;
        } else if (stat === 'rushing yards') {
            const rushingYards = getPlayerStat(player, 'rusYds');
            response = `${player.firstName} ${player.lastName} rushed for ${rushingYards} yards in the 2024 season.`;
        } else if (stat === 'receiving yards') {
            const receivingYards = getPlayerStat(player, 'recYds');
            response = `${player.firstName} ${player.lastName} had ${receivingYards} receiving yards in the 2024 season.`;
        } else if (stat === 'passing yards') {
            const passingYards = getPlayerStat(player, 'pssYds');
            response = `${player.firstName} ${player.lastName} threw for ${passingYards} yards in the 2024 season.`;
        } else if (stat === 'overall rating') {
            response = `${player.firstName} ${player.lastName} has an overall rating of ${player.ratings[0].ovr}.`;
        } else if (stat === 'speed') {
            response = `${player.firstName} ${player.lastName} has a speed rating of ${player.ratings[0].spd}.`;
        } else {
            response = 'Player stat not recognized. Try asking about touchdowns, speed, or yards.';
        }

        return response;
    }

    // Handle team queries
    function handleTeamQuery(query, team) {
        return `Team: ${team.name}, Championships: ${team.championships}`;
    }

    // Render player face manually using Canvas
    function renderPlayerFace(faceData) {
        if (!faceData) return;

        const canvas = document.getElementById('playerFaceCanvas');
        const ctx = canvas.getContext('2d');
        canvas.classList.remove('d-none');

        // Clear previous drawing
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Draw basic head (using color)
        ctx.fillStyle = faceData.body.color || "#f1c27d"; // Default skin color
        ctx.beginPath();
        ctx.arc(75, 75, 70, 0, 2 * Math.PI);
        ctx.fill();

        // Example face details (eyes, nose, etc.)
        ctx.fillStyle = "#000"; // Black eyes
        ctx.beginPath();
        ctx.arc(55, 65, 5, 0, 2 * Math.PI); // Left eye
        ctx.arc(95, 65, 5, 0, 2 * Math.PI); // Right eye
        ctx.fill();

        // Draw mouth
        ctx.strokeStyle = "#000";
        ctx.beginPath();
        ctx.moveTo(55, 100);
        ctx.quadraticCurveTo(75, 110, 95, 100); // Smiling mouth
        ctx.stroke();
    }

    // Render team logo
    function renderTeamLogo(imgURL) {
        const logo = document.getElementById('teamLogo');
        const logoContainer = document.getElementById('teamLogoContainer');
        logo.src = imgURL || 'https://via.placeholder.com/150'; // Default placeholder
        logoContainer.classList.remove('d-none');
    }
</script>


</body>
</html>
